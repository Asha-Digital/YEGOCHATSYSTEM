import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    onSnapshot, 
    serverTimestamp,
    query,
} from 'firebase/firestore';

// --- Helper: SVG Icons ---
const SendIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="22" y1="2" x2="11" y2="13"></line>
    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
  </svg>
);

const SparklesIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 3L9.5 8.5L4 11l5.5 2.5L12 19l2.5-5.5L20 11l-5.5-2.5z"/>
        <path d="M22 2L20 4"/>
        <path d="M4 22L2 20"/>
    </svg>
);

// --- ChatMessage Component ---
const ChatMessage = ({ message, currentUserId }) => {
    const { text, userId, displayName, timestamp, isAI } = message;
    const messageClass = userId === currentUserId ? 'sent' : 'received';

    const formatDate = (firebaseTimestamp) => {
        if (!firebaseTimestamp) return 'Just now';
        const date = firebaseTimestamp.toDate();
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    };

    return (
        <div className={`flex items-end ${messageClass === 'sent' ? 'justify-end' : 'justify-start'} mb-2`}>
            <div className={`flex flex-col space-y-2 text-sm max-w-xs mx-2 ${messageClass === 'sent' ? 'items-end' : 'items-start'}`}>
                <div>
                     <span className={`px-4 py-2 rounded-lg inline-block ${
                        isAI 
                        ? 'bg-gradient-to-r from-green-100 to-blue-100 text-gray-800 border border-green-300'
                        : messageClass === 'sent' 
                        ? 'bg-green-700 text-white rounded-br-none' 
                        : 'bg-gray-200 text-gray-800 rounded-bl-none'
                    }`}>
                        <p className={`font-semibold text-xs pb-1 ${isAI ? 'text-green-700' : 'text-gray-500'}`}>
                            {isAI ? 'AI' : displayName || 'Anonymous'}
                        </p>
                        {text}
                        <p className={`text-xs mt-1 ${isAI ? 'text-green-700' : 'text-gray-400'}`}>{formatDate(timestamp)}</p>
                    </span>
                </div>
            </div>
        </div>
    );
};

// --- Summary Modal ---
const SummaryModal = ({ summary, onClose }) => (
    <div className="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40">
        <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h2 className="text-lg font-bold mb-4">Chat Summary</h2>
            <p className="mb-4 whitespace-pre-line">{summary}</p>
            <button
                className="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800"
                onClick={onClose}
            >
                Close
            </button>
        </div>
    </div>
);

// --- Main App ---
const firebaseConfig = {
    // Your Firebase config here
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function App() {
    const [user, setUser] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [loading, setLoading] = useState(false);
    const [aiLoading, setAiLoading] = useState(false);
    const [summary, setSummary] = useState('');
    const [showSummary, setShowSummary] = useState(false);
    const messagesEndRef = useRef(null);

    // --- Authentication ---
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            if (user) {
                setUser(user);
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });
        return () => unsubscribe();
    }, []);

    // --- Listen for messages ---
    useEffect(() => {
        const q = query(collection(db, 'messages'));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const msgs = [];
            querySnapshot.forEach((doc) => {
                msgs.push({ id: doc.id, ...doc.data() });
            });
            setMessages(msgs.sort((a, b) => a.timestamp?.seconds - b.timestamp?.seconds));
        });
        return () => unsubscribe();
    }, []);

    // --- Scroll to bottom on new message ---
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    // --- Send message ---
    const sendMessage = async (e) => {
        e.preventDefault();
        if (!newMessage.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, 'messages'), {
                text: newMessage,
                userId: user.uid,
                displayName: user.isAnonymous ? 'Anonymous' : user.displayName,
                timestamp: serverTimestamp(),
                isAI: false,
            });
            setNewMessage('');
        } catch (err) {
            alert('Failed to send message');
        }
        setLoading(false);
    };

    // --- Ask AI (Islamic Q&A) ---
    const askAI = async () => {
        if (!newMessage.trim()) return;
        setAiLoading(true);
        try {
            // Add user message
            await addDoc(collection(db, 'messages'), {
                text: newMessage,
                userId: user.uid,
                displayName: user.isAnonymous ? 'Anonymous' : user.displayName,
                timestamp: serverTimestamp(),
                isAI: false,
            });
            setNewMessage('');
            // Simulate AI response (replace with real API call)
            setTimeout(async () => {
                await addDoc(collection(db, 'messages'), {
                    text: "This is an AI-generated answer to your Islamic question.",
                    userId: 'ai',
                    displayName: 'AI',
                    timestamp: serverTimestamp(),
                    isAI: true,
                });
                setAiLoading(false);
            }, 1500);
        } catch (err) {
            alert('Failed to ask AI');
            setAiLoading(false);
        }
    };

    // --- Summarize Chat ---
    const summarizeChat = async () => {
        setAiLoading(true);
        try {
            // Simulate summary (replace with real API call)
            setTimeout(() => {
                setSummary("This is a summary of your chat conversation.");
                setShowSummary(true);
                setAiLoading(false);
            }, 2000);
        } catch (err) {
            alert('Failed to summarize chat');
            setAiLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex flex-col items-center justify-center">
            <div className="w-full max-w-2xl bg-white rounded-lg shadow-lg p-6 flex flex-col h-[80vh]">
                <h1 className="text-2xl font-bold mb-4 text-green-700">Islamic Q&A Chat</h1>
                <div className="flex-1 overflow-y-auto mb-4">
                    {messages.map((msg) => (
                        <ChatMessage key={msg.id} message={msg} currentUserId={user?.uid} />
                    ))}
                    <div ref={messagesEndRef} />
                </div>
                <form onSubmit={sendMessage} className="flex items-center space-x-2">
                    <input
                        className="flex-1 border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-400"
                        type="text"
                        placeholder="Type your message..."
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        disabled={loading || aiLoading}
                    />
                    <button
                        type="submit"
                        className="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800 flex items-center"
                        disabled={loading || aiLoading}
                    >
                        <SendIcon />
                    </button>
                    <button
                        type="button"
                        className="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex items-center"
                        onClick={askAI}
                        disabled={aiLoading || loading}
                        title="Ask AI"
                    >
                        <SparklesIcon />
                    </button>
                    <button
                        type="button"
                        className="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 flex items-center"
                        onClick={summarizeChat}
                        disabled={aiLoading || loading}
                        title="Summarize Chat"
                    >
                        <span className="font-bold">Î£</span>
                    </button>
                </form>
                {(loading || aiLoading) && (
                    <div className="text-center text-green-700 mt-2">Processing...</div>
                )}
            </div>
            {showSummary && (
                <SummaryModal summary={summary} onClose={() => setShowSummary(false)} />
            )}
        </div>
    );
}

export default App;
